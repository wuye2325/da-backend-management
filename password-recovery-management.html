<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码找回管理 - 大家共治后台管理系统</title>
    <!-- 关键：先加载layout.js预设样式，再加载Tailwind -->
    <script src="js/layout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 引入组件 -->
    <script src="js/tab-system.js"></script>
    <script src="js/search-component.js"></script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- 侧边栏容器 -->
        <div id="sidebar-container"></div>

        <!-- 主内容区域 -->
        <div id="main-content" class="layout-main-content flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航容器 -->
            <div id="top-navigation-container"></div>
            
            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- 页面标题 -->
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">密码找回管理</h1>
                </div>

                <!-- 筛选区域 -->
                <div class="bg-white rounded-lg shadow mb-6 p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
                        <!-- 筛选字段 -->
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">申请时间</label>
                            <input type="date" id="startTime" class="w-full h-10 border border-gray-300 rounded-lg px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="lg:col-span-1">
                            <input type="date" id="endTime" placeholder="申请结束时间" class="w-full h-10 border border-gray-300 rounded-lg px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-7">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">用户角色</label>
                            <select id="roleFilter" class="w-full h-10 border border-gray-300 rounded-lg px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全部角色</option>
                                <option value="业委会主任">业委会主任</option>
                                <option value="业委会成员">业委会成员</option>
                                <option value="物业经理">物业经理</option>
                                <option value="物业人员">物业人员</option>
                                <option value="普通业主">普通业主</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                            <select id="statusFilter" class="w-full h-10 border border-gray-300 rounded-lg px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全部状态</option>
                                <option value="pending">待处理</option>
                                <option value="approved">已同意</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>
                        
                        <!-- 搜索组件容器 -->
                        <div id="search-container" class="lg:col-span-3"></div>
                    </div>
                </div>



                <!-- 数据表格 -->
                <div class="bg-white rounded-lg shadow">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">电话</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                     <div class="px-6 py-4 border-t border-gray-200">
                    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                        <!-- 左侧：记录信息和分页条数选择器 -->
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <div class="text-sm text-gray-500">
                                显示 <span class="font-medium">1-10</span> 条，共 <span class="font-medium">15</span> 条记录
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">每页显示</label>
                                <select id="pageSize" class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changePageSize()">
                                    <option value="10" selected>10条</option>
                                    <option value="20">20条</option>
                                    <option value="50">50条</option>
                                    <option value="100">100条</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 右侧：分页控件 -->
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <!-- 页码按钮组 -->
                            <div class="flex items-center space-x-1">
                                <!-- 上一页 -->
                                <button id="prevBtn" class="px-3 py-1 text-sm text-gray-500 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="previousPage()">
                                    <i class="fas fa-chevron-left mr-1"></i>上一页
                                </button>
                                
                                <!-- 页码按钮 -->
                                <button class="px-3 py-1 text-sm bg-blue-600 text-white rounded font-medium">1</button>
                                <button class="px-3 py-1 text-sm text-gray-700 border border-gray-300 rounded hover:bg-gray-50">2</button>
                                
                                <!-- 下一页 -->
                                <button id="nextBtn" class="px-3 py-1 text-sm text-gray-700 border border-gray-300 rounded hover:bg-gray-50" onclick="nextPage()">
                                    下一页<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                            
                            <!-- 页码跳转 -->
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">跳转到</span>
                                <input type="number" min="1" max="2" value="1" class="w-16 px-2 py-1 text-sm text-center border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-600">页</span>
                                <button class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    确定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                </div>
            </main>
        </div>
    </div>

    <script>
        // 示例数据
        const sampleData = [
            {
                id: 1,
                userName: '张三',
                phone: '13800138001',
                role: '业委会主任',
                applyTime: '2024-01-15 09:30:00',
                status: 'pending'
            },
            {
                id: 2,
                userName: '李四',
                phone: '13800138002',
                role: '物业经理',
                applyTime: '2024-01-14 14:20:00',
                status: 'approved'
            },
            {
                id: 3,
                userName: '王五',
                phone: '13800138003',
                role: '普通业主',
                applyTime: '2024-01-13 16:45:00',
                status: 'pending'
            },
            {
                id: 4,
                userName: '赵六',
                phone: '13800138004',
                role: '业委会成员',
                applyTime: '2024-01-12 11:15:00',
                status: 'rejected'
            },
            {
                id: 5,
                userName: '钱七',
                phone: '13800138005',
                role: '物业人员',
                applyTime: '2024-01-11 08:30:00',
                status: 'pending'
            },
            {
                id: 6,
                userName: '孙八',
                phone: '13800138006',
                role: '普通业主',
                applyTime: '2024-01-10 15:20:00',
                status: 'approved'
            },
            {
                id: 7,
                userName: '周九',
                phone: '13800138007',
                role: '业委会主任',
                applyTime: '2024-01-09 10:45:00',
                status: 'rejected'
            },
            {
                id: 8,
                userName: '吴十',
                phone: '13800138008',
                role: '物业经理',
                applyTime: '2024-01-08 13:30:00',
                status: 'pending'
            },
            {
                id: 9,
                userName: '郑十一',
                phone: '13800138009',
                role: '业委会成员',
                applyTime: '2024-01-07 17:15:00',
                status: 'approved'
            },
            {
                id: 10,
                userName: '王十二',
                phone: '13800138010',
                role: '普通业主',
                applyTime: '2024-01-06 09:50:00',
                status: 'pending'
            },
            {
                id: 11,
                userName: '冯十三',
                phone: '13800138011',
                role: '物业人员',
                applyTime: '2024-01-05 14:25:00',
                status: 'rejected'
            },
            {
                id: 12,
                userName: '陈十四',
                phone: '13800138012',
                role: '业委会主任',
                applyTime: '2024-01-04 11:40:00',
                status: 'approved'
            },
            {
                id: 13,
                userName: '褚十五',
                phone: '13800138013',
                role: '普通业主',
                applyTime: '2024-01-03 16:30:00',
                status: 'pending'
            },
            {
                id: 14,
                userName: '卫十六',
                phone: '13800138014',
                role: '物业人员',
                applyTime: '2024-01-02 08:15:00',
                status: 'approved'
            },
            {
                id: 15,
                userName: '蒋十七',
                phone: '13800138015',
                role: '业委会成员',
                applyTime: '2024-01-01 12:45:00',
                status: 'rejected'
            }
        ];

        // 全局变量
        let currentData = [...sampleData];
        let filteredData = [...sampleData];
        let currentPageNum = 1;
        let pageSizeNum = 10;
        let searchComponent;

        // 页面初始化
        function initializePage() {
            console.log('开始初始化页面...');
            console.log('sampleData:', sampleData);
            console.log('currentData:', currentData);
            console.log('filteredData:', filteredData);
            
            if (typeof initPage === 'function') {
                console.log('调用initPage函数...');
                initPage('password-recovery-management');
            }
            
            // 初始化全局页签系统
            if (typeof initGlobalTabSystem === 'function') {
                console.log('初始化全局页签系统...');
                initGlobalTabSystem();
            }
            
            // 初始化搜索组件
            if (typeof SearchComponent !== 'undefined') {
                console.log('初始化搜索组件...');
                searchComponent = new SearchComponent({
                    containerId: 'search-container',
                    placeholder: '搜索用户名或电话号码...',
                    onSearch: filterRecords,
                    onReset: resetFilters,
                    label: '搜索',
                    showLabel: true
                });
            } else {
                console.log('SearchComponent未定义，跳过初始化');
            }
            
            console.log('渲染表格...');
            renderTable();
            console.log('更新分页...');
            updatePagination();
            
            console.log('页面初始化完成');
        }
        
        // 使用多种方式确保页面初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            // DOM已经加载完成
            initializePage();
        }
        
        // 确保在所有资源加载完成后也执行一次
        window.addEventListener('load', initializePage);


        // 获取状态显示文本和样式
        function getStatusDisplay(status) {
            console.log('getStatusDisplay called with:', status);
            const statusMap = {
                'pending': { text: '待处理', class: 'bg-yellow-100 text-yellow-800' },
                'approved': { text: '已同意', class: 'bg-green-100 text-green-800' },
                'rejected': { text: '已拒绝', class: 'bg-red-100 text-red-800' }
            };
            const result = statusMap[status] || { text: '未知', class: 'bg-gray-100 text-gray-800' };
            console.log('getStatusDisplay result:', result);
            return result;
        }

        // 渲染表格
        function renderTable() {
            console.log('渲染表格函数被调用');
            const tbody = document.getElementById('recordsTableBody');
            console.log('tbody元素:', tbody);
            
            if (!tbody) {
                console.error('无法找到tbody元素');
                return;
            }
            
            // 检查所有需要的DOM元素
            const startTimeElement = document.getElementById('startTime');
            const endTimeElement = document.getElementById('endTime');
            const roleFilterElement = document.getElementById('roleFilter');
            const statusFilterElement = document.getElementById('statusFilter');
            const searchContainerElement = document.getElementById('search-container');
            
            console.log('DOM元素检查:', {
                startTimeElement: !!startTimeElement,
                endTimeElement: !!endTimeElement,
                roleFilterElement: !!roleFilterElement,
                statusFilterElement: !!statusFilterElement,
                searchContainerElement: !!searchContainerElement
            });
            
            const startIndex = (currentPageNum - 1) * pageSizeNum;
            const endIndex = startIndex + pageSizeNum;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            console.log('当前页数据:', pageData);
            
            tbody.innerHTML = '';
            
            if (pageData.length === 0) {
                console.log('没有数据可显示');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            暂无数据
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log('渲染数据行...');
            pageData.forEach((record, index) => {
                const statusDisplay = getStatusDisplay(record.status);
                const canOperate = record.status === 'pending';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.userName}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${record.phone}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${record.role}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${record.applyTime}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusDisplay.class}">
                                ${statusDisplay.text}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm space-x-2">
                            <button onclick="${canOperate ? `approveRecord(${record.id})` : 'return false'}" 
                                    class="${canOperate ? 'text-green-600 hover:text-green-900' : 'text-gray-400 cursor-not-allowed'} font-medium"
                                    ${canOperate ? '' : 'disabled'}>
                                同意
                            </button>
                            <button onclick="${canOperate ? `rejectRecord(${record.id})` : 'return false'}" 
                                    class="${canOperate ? 'text-red-600 hover:text-red-900' : 'text-gray-400 cursor-not-allowed'} font-medium"
                                    ${canOperate ? '' : 'disabled'}>
                                拒绝
                            </button>
                        </td>
                    </tr>
                `;
            });
            console.log('表格渲染完成');
        }

        // 筛选记录
        function filterRecords() {
            console.log('filterRecords function called');
            try {
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const roleFilter = document.getElementById('roleFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const searchKeyword = searchComponent ? searchComponent.getValue().toLowerCase() : '';
                
                console.log('筛选条件:', {startTime, endTime, roleFilter, statusFilter, searchKeyword});
                
                filteredData = currentData.filter(record => {
                    // 时间筛选
                    if (startTime) {
                        const recordDate = new Date(record.applyTime);
                        const filterStartDate = new Date(startTime);
                        if (recordDate < filterStartDate) return false;
                    }
                    if (endTime) {
                        const recordDate = new Date(record.applyTime);
                        const filterEndDate = new Date(endTime);
                        filterEndDate.setHours(23, 59, 59, 999);
                        if (recordDate > filterEndDate) return false;
                    }

                    // 角色筛选
                    if (roleFilter && record.role !== roleFilter) return false;

                    // 状态
                    if (statusFilter && record.status !== statusFilter) return false;

                    // 全文搜索（用户名、电话）
                    if (searchKeyword) {
                        const searchText = `${record.userName} ${record.phone}`.toLowerCase();
                        if (!searchText.includes(searchKeyword)) return false;
                    }

                    return true;
                });
                
                console.log('筛选后的数据:', filteredData);
                
                currentPageNum = 1;
                renderTable();
                updatePagination();
            } catch (error) {
                console.error('filterRecords函数执行出错:', error);
            }
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            
            // 重置搜索组件
            if (searchComponent) {
                searchComponent.reset();
            }
            
            filteredData = [...currentData];
            currentPageNum = 1;
            renderTable();
            updatePagination();
        }



        // 同意申请
        function approveRecord(recordId) {
            if (confirm('确定要同意这个密码找回申请吗？')) {
                const record = currentData.find(r => r.id === recordId);
                if (record) {
                    record.status = 'approved';
                    renderTable();
                    showMessage('操作成功！已同意该用户的密码找回申请。', 'success');
                }
            }
        }

        // 拒绝申请
        function rejectRecord(recordId) {
            if (confirm('确定要拒绝这个密码找回申请吗？')) {
                const record = currentData.find(r => r.id === recordId);
                if (record) {
                    record.status = 'rejected';
                    renderTable();
                    showMessage('操作成功！已拒绝该用户的密码找回申请。', 'success');
                }
            }
        }



        // 更新分页
        function updatePagination() {
            console.log('updatePagination function called');
            try {
                const totalPages = Math.ceil(filteredData.length / pageSizeNum);
                console.log('总页数:', totalPages, '当前页:', currentPageNum, '数据总数:', filteredData.length, '每页数量:', pageSizeNum);
                
                // 更新上一页和下一页按钮状态
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (prevBtn) {
                    prevBtn.disabled = currentPageNum <= 1;
                    console.log('上一页按钮状态:', prevBtn.disabled);
                }
                
                if (nextBtn) {
                    nextBtn.disabled = currentPageNum >= totalPages;
                    console.log('下一页按钮状态:', nextBtn.disabled);
                }
            } catch (error) {
                console.error('updatePagination函数执行出错:', error);
            }
        }

        // 上一页
        function previousPage() {
            if (currentPageNum > 1) {
                currentPageNum--;
                renderTable();
                updatePagination();
            }
        }

        // 下一页
        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / pageSizeNum);
            if (currentPageNum < totalPages) {
                currentPageNum++;
                renderTable();
                updatePagination();
            }
        }

        // 改变每页显示数量
        function changePageSize() {
            pageSizeNum = parseInt(document.getElementById('pageSize').value);
            currentPageNum = 1;
            renderTable();
            updatePagination();
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }
    </script>
    
    </body>
</html>