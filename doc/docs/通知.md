# DA-SOLO 通知功能业务逻辑分析文档

## 概述

  DA-SOLO 的通知功能是一个完整的业委会通知管理系统，实现了从通知创建、审批流程、发布推送到用户交互的全套业务流程。本文档基于代码
  分析，详细描述了该系统的业务逻辑和技术架构。

  1. 系统架构概览

  技术栈

  - 前端: React + TypeScript + Zustand（状态管理）
  - 后端: Supabase（PostgreSQL + Auth + Real-time）
  - UI框架: Arco Design + Tailwind CSS + shadcn/ui（混合）
  - AI集成: 硅基流动 (SiliconFlow) 支持内容摘要

  核心模块

  通知系统
  ├── 数据服务层 (Services)
  │   ├── NotificationService         # 通知CRUD操作
  │   ├── NotificationPushService     # 推送服务
  │   └── ApprovalWorkflowService     # 审批工作流
  ├── 状态管理层 (Store)
  │   └── useStore                    # Zustand状态管理
  ├── 用户界面层 (Pages)
  │   ├── NotificationCreate          # 通知创建/编辑
  │   ├── NotificationList            # 通知列表
  │   └── NotificationDetail          # 通知详情
  └── 组件层 (Components)
      ├── NotificationForm            # 通知表单
      ├── NotificationCard            # 通知卡片
      ├── ApprovalFlow                # 审批流程展示
      └── VotingActionBar             # 投票操作栏

  2. 业务流程分析

  2.1 通知生命周期

  通知在系统中经历以下状态转换：

  draft → pending_approval → published/rejected
    ↑                            ↓
    └──── 可编辑 ←──────────────────┘

  状态说明:
  - draft: 草稿状态，可编辑和删除
  - pending_approval: 待审批状态，进入投票流程
  - published: 已发布状态，对目标受众可见
  - rejected: 已拒绝状态，审批未通过

  2.2 角色权限体系

  系统基于以下角色实现权限控制：

  | 角色                       | 权限                   |
  |--------------------------|----------------------|
  | OWNER (业主)               | 查看已发布通知、点赞/点踩、订阅     |
  | COMMITTEE_MEMBER (业委会成员) | 创建通知、编辑草稿、投票审批、管理员操作 |
  | PROPERTY_MANAGER (物业经理)  | 查看通知、管理员强制操作         |

  2.3 审批工作流机制

  过半审批规则

  - 触发条件: 通知提交审批后自动创建工作流
  - 投票成员: 所有激活的业委会成员
  - 决策机制: 基于过半数原则
    - 赞成票 > 总成员数/2 → 自动通过
    - 反对票 > 总成员数/2 → 自动拒绝
    - 投票未达过半数 → 保持待审批状态

  投票权限检查

  // 投票权限验证逻辑
  1. 用户角色必须是 COMMITTEE_MEMBER
  2. 用户账户状态为激活
  3. 通知状态为 pending_approval
  4. 用户未重复投票
  5. 允许作者为自己的通知投票（民主决策原则）

  2.4 推送机制

  目标受众类型

  - all: 全体业主
  - building: 指定建筑物
  - role: 指定角色

  推送渠道

  1. 消息中心: 存储到 messages 表
  2. 浏览器推送: Web Notification API
  3. 邮件通知: 预留接口（未实现）
  4. 未读计数: localStorage + 全局事件

  推送统计

  系统记录详细的推送统计信息：
  - 目标用户总数
  - 成功推送数量
  - 失败推送数量
  - 推送成功率

  3. 前端组件架构

  3.1 页面组件分析

  NotificationCreate（通知创建页面）

  核心功能:
  - 权限检查：仅业委会成员可访问
  - 双模式：创建新通知 / 编辑现有草稿
  - 表单验证：标题、内容、受众等必填项
  - 操作选项：保存草稿 / 提交审批

  关键业务逻辑:
  // 编辑权限检查
  if (notification.author_id !== currentUser?.id) {
    // 只能编辑自己创建的通知
  }
  if (notification.status !== 'draft') {
    // 只有草稿状态可编辑
  }

  NotificationList（通知列表页面）

  核心功能:
  - Tab切换：全部/已发布/待审批/已拒绝/草稿
  - 权限过滤：非业委会成员无法查看受限Tab
  - 置顶显示：重要通知优先展示
  - 分页加载：支持无限滚动

  状态筛选逻辑:
  // Tab权限控制
  const restrictedTabs = ['pending_approval', 'rejected', 'draft'];
  if (!isCommitteeMember && restrictedTabs.includes(activeTab)) {
    setActiveTab('all'); // 强制切换到全部Tab
  }

  NotificationDetail（通知详情页面）

  核心功能:
  - 自动标记已读
  - 富文本内容展示
  - 附件预览下载
  - 审批流程可视化
  - 移动端阅读优化

  交互统计:
  - 浏览次数自动增加
  - 点赞/点踩状态同步
  - 实时数据刷新

  3.2 核心组件分析

  NotificationForm（通知表单组件）

  表单字段:
  interface NotificationFormData {
    title: string;                    // 标题
    content: string;                  // 富文本内容
    notification_type: NotificationType; // 通知类型
    target_audience: NotificationAudience; // 目标受众
    target_details?: string;          // 受众详情
    priority: 'low' | 'normal' | 'high'; // 优先级
    images: string[];                 // 图片附件
    attachments: NotificationAttachment[]; // 文件附件
    is_pinned: boolean;              // 是否置顶
    related_event_id?: string;       // 关联事件ID
  }

  EnhancedApprovalFlow（增强版审批流程组件）

  功能特性:
  - 实时投票统计显示
  - 进度条可视化
  - 投票历史展示
  - 决策状态指示

  VotingActionBar（投票操作栏）

  核心功能:
  - 底部固定布局
  - 三选一投票：赞成/反对/弃权
  - 投票评论功能
  - 权限状态检查

  4. 后端服务架构

  4.1 NotificationService（通知服务）

  核心方法:
  class NotificationService {
    // CRUD操作
    static createNotification(formData, authorId)
    static updateNotification(id, updates)
    static deleteNotification(id)
    static getNotifications(params, userId)
    static getNotificationById(id, userId)

    // 状态管理
    static publishNotification(id)
    static markAsRead(id, userId)
    static pinNotification(id, isPinned)

    // 交互功能
    static likeNotification(id, userId)
    static dislikeNotification(id, userId)
    static toggleSubscription(id, userId)

    // 审批相关
    static voteOnNotification(id, approverId, vote, comment)
    static getApprovalStats(id)
    static getApprovalWorkflows(userId)
  }

  4.2 ApprovalWorkflowService（审批工作流服务）

  工作流管理:
  class ApprovalWorkflowService {
    // 工作流管理
    static createWorkflow(notificationId)
    static submitVote(notificationId, approverId, vote, comment)

    // 权限检查
    static canUserVote(userId, notificationId)

    // 自动决策
    static checkAutoDecision(notificationId)
    static executeAutoDecision(notificationId, decision)

    // 管理员功能
    static forceApprove(notificationId, adminUserId, reason)
    static forceReject(notificationId, adminUserId, reason)
  }

  自动决策算法:
  // 过半数计算逻辑
  const majority_threshold = Math.floor(total_committee_members / 2) + 1;
  const is_approved = approve_count >= majority_threshold;
  const is_rejected = reject_count >= majority_threshold;

  4.3 NotificationPushService（推送服务）

  推送流程:
  1. 目标用户获取: 根据受众类型筛选用户
  2. 推送负载创建: 生成标准化推送数据
  3. 多渠道推送: 消息中心 + 浏览器通知 + 邮件
  4. 统计记录: 推送成功率和失败原因

  5. 状态管理（Zustand Store）

  5.1 通知状态结构

  interface NotificationState {
    // 数据状态
    notifications: Notification[];           // 通知列表
    currentNotification: Notification | null; // 当前通知
    approvalWorkflows: NotificationApprovalWorkflow[]; // 审批工作流

    // UI状态
    activeNotificationTab: NotificationStatus | 'all'; // 活跃Tab
    isNotificationLoading: boolean;          // 加载状态
    notificationError: string | null;        // 错误信息

    // 统计数据
    notificationCounts: {                    // Tab计数
      all: number;
      published: number;
      pending_approval: number;
      rejected: number;
      draft: number;
    };
  }

  5.2 关键Action分析

  通知CRUD操作

  // 创建通知
  addNotification: async (formData) => {
    const notification = await NotificationService.createNotification(formData, currentUser.id);
    set(state => ({
      notifications: [notification, ...state.notifications]
    }));
  }

  // 提交审批
  submitNotificationForApproval: async (id) => {
    const workflowId = await ApprovalWorkflowService.createWorkflow(id);
    // 更新通知状态为 pending_approval
  }

  投票处理

  voteOnNotification: async (id, vote, comment) => {
    const result = await ApprovalWorkflowService.submitVote(id, currentUser.id, vote, comment);

    // 处理自动决策结果
    if (result.decision && result.workflowUpdated) {
      if (result.decision.decision === 'approved') {
        // 更新为已发布状态
      } else if (result.decision.decision === 'rejected') {
        // 更新为已拒绝状态
      }
    }
  }

  6. 数据库设计要点

  6.1 核心表结构

  notifications表（通知主表）:
  - id: 通知唯一标识
  - title: 通知标题
  - content: 富文本内容
  - status: 通知状态
  - notification_type: 通知类型
  - target_audience: 目标受众
  - author_id: 创建者ID
  - created_at/updated_at: 时间戳
  - is_pinned: 是否置顶

  notification_approvals表（审批记录）:
  - notification_id: 关联通知ID
  - approver_id: 投票人ID
  - vote: 投票选择（approve/reject/abstain）
  - comment: 投票评论
  - created_at: 投票时间

  messages表（消息中心）:
  - type: 消息类型
  - to_user_id: 接收用户ID
  - target_id: 关联通知ID
  - target_type: 关联类型
  - is_read: 是否已读

  6.2 RLS策略

  系统实现了基于角色的行级安全策略：
  - 业主只能查看已发布通知
  - 业委会成员可查看所有状态通知
  - 创建者可以编辑自己的草稿
  - 投票记录仅投票人和管理员可见

  7. 业务特色功能

  7.1 智能推送策略

  推送范围控制:
  - 全体推送：重要公告
  - 建筑物推送：区域性通知
  - 角色推送：针对性信息

  推送优先级:
  - 高优先级：置顶通知，长时间显示
  - 普通优先级：5秒后自动消失
  - 低优先级：仅消息中心记录

  7.2 民主决策机制

  过半数原则:
  - 严格按照民主决策原则
  - 作者可为自己的提案投票
  - 自动执行决策结果
  - 透明的投票过程

  管理员干预:
  - 紧急情况下的强制操作
  - 操作日志完整记录
  - 通知作者和相关人员

  7.3 用户体验优化

  移动端适配:
  - 响应式设计
  - 触摸友好的操作界面
  - 离线缓存支持

  实时更新:
  - Supabase实时订阅
  - 状态同步
  - 无缝用户体验

  8. 安全性考虑

  8.1 权限控制

  - 基于角色的访问控制（RBAC）
  - 操作权限细粒度控制
  - 数据行级安全策略

  8.2 数据验证

  - 前端表单验证
  - 后端数据校验
  - SQL注入防护

  8.3 审计日志

  - 投票记录不可篡改
  - 操作日志完整记录
  - 管理员操作追踪

  9. 总结

  DA-SOLO的通知功能是一个设计完善的社区管理系统，具有以下特点：

  1. 完整的业务流程: 从创建到发布的全生命周期管理
  2. 民主决策机制: 基于过半数原则的审批工作流
  3. 多渠道推送: 消息中心、浏览器通知、邮件等
  4. 权限精细控制: 基于角色的多层权限管理
  5. 用户体验优秀: 移动端优化、实时更新、交互友好
  6. 技术架构先进: React + TypeScript + Supabase 现代化技术栈

  该系统成功地将社区管理的业务需求转化为技术实现，为住宅小区的数字化管理提供了完整的解决方案。